# MEME Launchpad 开发指南

## 项目概述

MEME Launchpad 是一个基于区块链的代币启动平台，允许用户创建和交易 MEME 代币。平台采用 Bonding Curve（联合曲线）机制进行代币定价，当代币达到一定条件后，会自动"毕业"并将流动性转移到 PancakeSwap 等 DEX。

### 核心特性

- **Bonding Curve 定价**：使用恒定乘积公式实现代币价格自动调节
- **自动毕业机制**：当代币可售量低于阈值时，自动添加流动性到 DEX
- **代币归属管理**：支持多种归属模式（销毁、悬崖、线性）
- **CREATE2 部署**：使用 CREATE2 操作码实现可预测的合约地址
- **UUPS 升级模式**：支持合约升级
- **多链支持**：支持 BSC、Base、XLayer 等多条链

## 技术栈

### 开发框架
- **Foundry**：Solidity 开发框架
- **Solidity ^0.8.20**：智能合约编程语言
- **OpenZeppelin Contracts**：安全合约库

### 核心依赖
```toml
@openzeppelin/contracts-upgradeable/
@openzeppelin/contracts/
forge-std/
```

### 外部集成
- **PancakeSwap V2**：流动性池和路由器
- **WBNB**：包装 BNB 代币

## 项目结构

```
meme-launchpad-moon/
├── src/                          # 合约源代码
│   ├── MEMECore.sol             # 核心合约（代币创建、交易、毕业）
│   ├── MEMEFactory.sol          # 工厂合约（部署代币合约）
│   ├── MEMEHelper.sol           # 辅助合约（曲线计算、DEX 交互）
│   ├── MEMEToken.sol            # 代币合约（ERC20 实现）
│   ├── MEMEVesting.sol          # 归属合约（代币归属管理）
│   └── interfaces/              # 接口定义
│       ├── IMEMECore.sol
│       ├── IMEMEFactory.sol
│       ├── IMEMEHelper.sol
│       ├── IMEMEVesting.sol
│       └── ...
├── test/                         # 测试文件
│   ├── MEMECore.t.sol
│   ├── Vesting.t.sol
│   └── mocks/                    # Mock 合约
├── script/                       # 部署脚本
│   ├── Deploy.s.sol
│   ├── DeployFactory.sol
│   └── Deployer.sol
├── foundry.toml                  # Foundry 配置文件
└── deploy-config/                # 部署配置
```

## 核心合约说明

### 1. MEMECore.sol - 核心合约

**职责**：
- 代币创建和管理
- Bonding Curve 交易（买入/卖出）
- 代币毕业流程
- 紧急暂停机制

**关键功能**：
- `createToken()`：创建新代币
- `buy()`：通过 Bonding Curve 买入代币
- `sell()`：通过 Bonding Curve 卖出代币
- `graduate()`：将代币流动性转移到 DEX
- `pause()`/`unpause()`：紧急暂停/恢复

**重要状态变量**：
```solidity
struct TokenInfo {
    address creator;              // 创建者地址
    address tokenAddress;          // 代币合约地址
    uint256 totalSupply;           // 总供应量
    uint256 availableSupply;       // 可售供应量
    uint256 virtualBNBReserve;     // 虚拟 BNB 储备
    uint256 virtualTokenReserve;   // 虚拟代币储备
    TokenStatus status;            // 代币状态
    uint256 creationTime;           // 创建时间
}
```

### 2. MEMEFactory.sol - 工厂合约

**职责**：
- 使用 CREATE2 部署新的 MEMEToken 合约
- 管理已部署的代币列表

**关键功能**：
- `deployToken()`：部署新的代币合约
- `predictTokenAddress()`：预测代币合约地址

**CREATE2 地址计算**：
```solidity
bytes32 salt = keccak256(abi.encodePacked(timestamp, nonce));
address predictedAddress = address(uint160(uint256(keccak256(abi.encodePacked(
    hex"d694",
    address(this),
    salt,
    keccak256(abi.encodePacked(
        type(MEMEToken).creationCode,
        abi.encode(name, symbol, totalSupply, address(memeCore))
    ))
)))));
```

### 3. MEMEHelper.sol - 辅助合约

**职责**：
- Bonding Curve 数学计算
- 与 PancakeSwap 交互
- 添加流动性

**关键功能**：
- `calculateTokenAmountOut()`：计算买入可获得的代币数量
- `calculateBNBAmountOut()`：计算卖出可获得的 BNB 数量
- `addLiquidity()`：添加流动性到 PancakeSwap

**Bonding Curve 公式**：
```
k = virtualBNBReserve × virtualTokenReserve
newBNBReserve = virtualBNBReserve + bnbIn
newTokenReserve = k / newBNBReserve
tokenOut = virtualTokenReserve - newTokenReserve
```

### 4. MEMEToken.sol - 代币合约

**职责**：
- 实现 ERC20 标准
- 控制代币转账权限

**转账模式**：
```solidity
enum TransferMode {
    MODE_NORMAL,              // 正常模式（自由转账）
    MODE_TRANSFER_RESTRICTED, // 限制模式（禁止所有转账）
    MODE_TRANSFER_CONTROLLED  // 受控模式（仅允许曲线交易）
}
```

### 5. MEMEVesting.sol - 归属合约

**职责**：
- 管理代币归属计划
- 支持多种归属模式

**归属模式**：
```solidity
enum VestingMode {
    BURN,   // 销毁模式（代币永久销毁）
    CLIFF,  // 悬崖模式（到期一次性释放）
    LINEAR  // 线性模式（按时间比例释放）
}
```

## 开发环境搭建

### 1. 安装 Foundry

```bash
# 安装 Foundry
curl -L https://foundry.paradigm.xyz | bash
foundryup

# 验证安装
forge --version
cast --version
anvil --version
```

### 2. 克隆项目

```bash
git clone https://github.com/your-repo/meme-launchpad-moon.git
cd meme-launchpad-moon
```

### 3. 安装依赖

```bash
forge install
```

### 4. 配置环境变量

创建 `.env` 文件：

```bash
# RPC 端点
ETH_MAIN_RPC=https://eth-mainnet.alchemyapi.io/v2/YOUR_API_KEY
BSC_MAIN_RPC=https://bsc-dataseed.binance.org/
BSC_TEST_RPC=https://data-seed-prebsc-1-s1.binance.org:8545/
BASE_MAIN_RPC=https://mainnet.base.org
BASE_SEPOLIA_RPC=https://sepolia.base.org
XLAYER_MAIN_RPC=https://rpc.xlayer.tech
XLAYER_TEST_RPC=https://rpc-test.xlayer.tech

# API 密钥
ETH_API_KEY=your_etherscan_api_key
BNB_API_KEY=your_bscscan_api_key
XLAYER_API_KEY=your_xlayer_api_key
```

### 5. 编译合约

```bash
# 编译所有合约
forge build

# 编译特定合约
forge build --contracts src/MEMECore.sol
```

## 测试

### 运行所有测试

```bash
forge test
```

### 运行特定测试

```bash
# 测试特定合约
forge test --match-contract MEMECoreTest

# 测试特定函数
forge test --match-test testCreateToken

# 显示详细输出
forge test -vvv

# 生成测试覆盖率报告
forge coverage
```

### 测试文件结构

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import "../src/MEMECore.sol";

contract MEMECoreTest is Test {
    MEMECore public memeCore;
    
    function setUp() public {
        // 设置测试环境
    }
    
    function testCreateToken() public {
        // 测试代币创建
    }
}
```

## 部署流程

### 1. 部署配置

在 `deploy-config/` 目录下创建部署配置文件：

```json
{
    "network": "bsc",
    "factoryAddress": "0x...",
    "helperAddress": "0x...",
    "vestingAddress": "0x...",
    "signerAddress": "0x...",
    "feeConfig": {
        "protocolFee": 100,      // 1%
        "creatorFee": 200,       // 2%
        "referralFee": 50       // 0.5%
    }
}
```

### 2. 部署脚本

使用 Foundry 脚本部署：

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Script.sol";
import "../src/MEMECore.sol";
import "../src/MEMEFactory.sol";
import "../src/MEMEHelper.sol";
import "../src/MEMEVesting.sol";

contract Deploy is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        vm.startBroadcast(deployerPrivateKey);
        
        // 部署工厂合约
        MEMEFactory factory = new MEMEFactory();
        
        // 部署辅助合约
        MEMEHelper helper = new MEMEHelper();
        
        // 部署归属合约
        MEMEVesting vesting = new MEMEVesting();
        
        // 部署核心合约
        MEMECore core = new MEMECore(
            address(factory),
            address(helper),
            address(vesting),
            address(0x...), // 签名者地址
            100,            // 协议费率 1%
            200,            // 创建者费率 2%
            50              // 推荐费率 0.5%
        );
        
        // 设置权限
        factory.grantRole(factory.DEPLOYER_ROLE(), address(core));
        
        vm.stopBroadcast();
    }
}
```

### 3. 执行部署

```bash
# 部署到 BSC 主网
forge script script/Deploy.s.sol:Deploy --rpc-url $BSC_MAIN_RPC --broadcast --verify

# 部署到 BSC 测试网
forge script script/Deploy.s.sol:Deploy --rpc-url $BSC_TEST_RPC --broadcast --verify
```

### 4. 验证部署

```bash
# 验证合约
forge verify-contract <CONTRACT_ADDRESS> <CONTRACT_NAME> \
  --chain-id <CHAIN_ID> \
  --watch
```

## 开发注意事项

### 安全性

1. **重入攻击防护**：
   - 所有涉及外部调用的函数都使用 `nonReentrant` 修饰符
   - 遵循检查-效果-交互模式

2. **访问控制**：
   - 使用 OpenZeppelin 的 AccessControl 进行权限管理
   - 敏感操作需要特定角色权限

3. **暂停机制**：
   - 实现紧急暂停功能
   - 暂停期间禁止所有交易操作

4. **输入验证**：
   - 验证所有外部输入
   - 检查参数范围和有效性

### Gas 优化

1. **使用 CREATE2**：
   - 预先计算合约地址，节省 Gas
   - 避免重复部署

2. **打包存储**：
   - 使用 uint256 存储多个小数值
   - 合理安排存储槽位

3. **事件日志**：
   - 使用索引参数提高查询效率
   - 避免在事件中存储过多数据

### 升级策略

1. **UUPS 模式**：
   - 使用 OpenZeppelin 的 UUPSUpgradeable
   - 升级逻辑在实现合约中

2. **升级流程**：
   ```solidity
   function upgradeTo(address newImplementation) external onlyOwner {
       _authorizeUpgrade(newImplementation);
       _upgradeToAndCallUUPS(newImplementation, new bytes(0), false);
   }
   ```

### 多链部署

1. **配置管理**：
   - 为每条链维护独立的配置文件
   - 使用环境变量管理 RPC 端点

2. **跨链兼容性**：
   - 测试每条链的 Gas 限制
   - 验证 DEX 路由器地址

### 调试技巧

1. **使用 Foundry 调试**：
   ```bash
   forge test --debug testFunctionName
   ```

2. **打印日志**：
   ```solidity
   console.log("Token address:", tokenAddress);
   console.log("Amount:", amount);
   ```

3. **状态检查**：
   ```bash
   cast call <CONTRACT_ADDRESS> "tokenInfo(address)" <TOKEN_ADDRESS>
   ```

## 常见问题

### Q1: 如何计算 Bonding Curve 价格？

A: 使用恒定乘积公式：
```solidity
// 买入价格
tokenOut = (virtualTokenReserve * bnbIn) / (virtualBNBReserve + bnbIn)

// 卖出价格
bnbOut = (virtualBNBReserve * tokenIn) / (virtualTokenReserve + tokenIn)
```

### Q2: 代币什么时候毕业？

A: 当满足以下条件时自动毕业：
- 可售供应量低于阈值（默认 10%）
- 当前状态为 TRADING

### Q3: 如何添加新的代币归属模式？

A: 在 `MEMEVesting.sol` 中添加新的枚举值和对应的计算逻辑。

### Q4: 如何修改费率配置？

A: 调用 `setProtocolFee()`、`setCreatorFee()` 或 `setReferralFee()` 函数。

### Q5: 如何处理紧急情况？

A: 调用 `pause()` 暂停所有交易，然后调用 `emergencyWithdraw()` 提取资金。

## 参考资料

- [Foundry 文档](https://book.getfoundry.sh/)
- [OpenZeppelin 合约](https://docs.openzeppelin.com/contracts)
- [Solidity 文档](https://docs.soliditylang.org/)
- [PancakeSwap 文档](https://docs.pancakeswap.finance/)

## 贡献指南

1. Fork 项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

## 许可证

MIT License
